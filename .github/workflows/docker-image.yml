name: Docker Image CI

on:
  # 保留原有触发条件
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  # ====================== 新增：GitHub Release发布时触发 ======================
  release:
    types: [ published ]  # 仅当Release正式发布（published）时触发，忽略draft（草稿）、edited（编辑）等
# ==========================================================================

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ====================== 新增：获取GitHub Release版本标签 ======================
    - name: 获取GitHub Release标签（用于Docker标签）
      id: get_release_tag
      run: |
        # 判断是否为Release事件，若是则提取标签名
        if [ "${{ github.event_name }}" = "release" ]; then
          # 获取Release标签名（如v1.0.0），并简单清洗
          RELEASE_TAG=${{ github.event.release.tag_name }}
          # 清洗Release标签（避免特殊字符，可选，因手动创建的标签通常合规）
          CLEAN_RELEASE_TAG=$(echo "$RELEASE_TAG" | \
            sed -e 's/[^a-z0-9\.\-]/-/g' | \
            sed -e 's/^-\+//' -e 's/-\+$//')
          echo "Release标签（清洗后）：$CLEAN_RELEASE_TAG"
          echo "CLEAN_RELEASE_TAG=$CLEAN_RELEASE_TAG" >> $GITHUB_ENV
        else
          # 非Release事件，设置为空字符串
          echo "非Release事件，不设置Release标签"
          echo "CLEAN_RELEASE_TAG=" >> $GITHUB_ENV
        fi
    # ==========================================================================
    
    # ====================== 新增：获取Git提交SHA（用于Push事件的标签） ======================
    - name: 获取Git提交SHA
      id: get_commit_sha
      run: |
        # 获取短SHA（前7位）
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        echo "短提交SHA: $SHORT_SHA"
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
    # ==========================================================================

    - name: Build and push Docker image
      # 只在push到master或release发布时运行
      if: |
        (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
        (github.event_name == 'release' && github.event.action == 'published')
      uses: docker/build-push-action@v4
      with:
        context: .
        file: Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/auto-music:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/auto-music:${{ github.event_name == 'push' && env.SHORT_SHA || (github.event_name == 'release' && env.CLEAN_RELEASE_TAG) || '' }}
    
    - name: Prune Docker (Local Cleanup)
      if: always()
      run: |
        docker system prune -a -f
        docker buildx prune -f
